<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AutoNestCut</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="diagrams_style.css">
    <link rel="stylesheet" href="resizer_fix.css">
    <style>
        .currency-conversion {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .currency-conversion label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .currency-conversion select,
        .currency-conversion input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .currency-conversion button {
            margin-top: 10px;
            padding: 8px 16px;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .currency-conversion button:hover {
            background: #005a87;
        }
        /* Icon button specific styling, ensure it's clean and consistent */
        .icon-btn, .material-icon-btn {
            padding: 5px; /* Adjust padding as needed for icon size */
            background: #ffffff; /* Default background */
            color: #24292e; /* Default icon color */
            border: 1px solid #d0d7de; /* Default border */
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .icon-btn:hover, .material-icon-btn:hover {
            background: #f6f8fa;
            border-color: #8c959f;
        }
        /* Override for header action buttons for primary blue look */
        .header-controls .action-buttons .tab-button.icon-btn {
            background: #007cba;
            color: white;
            border: none; /* No border for these primary action icons */
        }
        .header-controls .action-buttons .tab-button.icon-btn:hover {
            background: #005a87;
            border-color: transparent;
        }
        .icon-btn svg, .material-icon-btn svg {
            stroke: currentColor; /* Ensure SVG uses button's text color */
            stroke-width: 2;
            width: 16px;
            height: 16px;
        }
        #settingsModal {
            z-index: 1000;
        }
        #settingsModal .modal-content {
            z-index: 1001;
        }
    </style>
    <script src="languages.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1 data-translate="app_title">AutoNestCut v2.7.0 - Updated UI (2024-05-18)</h1>
            <p class="developer-credit" data-translate="developer_credit">Developed by: Int. Arch. M.Shkeir</p>
        </div>
        <div class="header-controls">
            <!-- Settings Button - Always visible -->
            <button class="settings-btn icon-btn" onclick="openSettings()" title="Settings">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m21-7h-6M7 5H1m21 7h-6M7 19H1"/>
                </svg>
            </button>
            <button class="settings-btn icon-btn report-action-btn" id="globalTableSettingsBtn" onclick="toggleGlobalTableSettings()" title="Global Table Settings" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <path d="M9 9h6v6H9z"/>
                    <path d="M9 3v6M15 3v6M21 9H3M21 15H3"/>
                </svg>
            </button>
            <div class="action-buttons">
                <!-- Configuration Tab Buttons -->
                <button class="tab-button" id="generateCutListButton" onclick="processNesting()" data-translate="generate_cut_list">Generate Cut List</button>
                <button class="tab-button" id="refreshSelectionButton" onclick="refreshConfiguration()" data-translate="refresh_selection">Refresh Selection</button>
                <button class="tab-button" id="cancelButton" onclick="window.close()" data-translate="cancel">Cancel</button>

                <!-- Report Tab Buttons - Hidden by default -->
                <button class="tab-button icon-btn report-action-btn" id="refreshReportButton" onclick="refreshReportWithFeedback()" data-translate="refresh_report" style="display: none;" title="Refresh Report">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                        <path d="M21 3v5h-5"/>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                        <path d="M3 21v-5h5"/>
                    </svg>
                </button>
                <button class="tab-button icon-btn report-action-btn" id="printButton" data-translate="print_save_pdf" style="display: none;" title="Print / Save PDF">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6,9 6,2 18,2 18,9"/>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                        <polyline points="6,14 6,22 18,22 18,14"/>
                    </svg>
                </button>
                <button class="tab-button icon-btn report-action-btn" id="exportCsvButton" data-translate="export_csv_report" style="display: none;" title="Export CSV Report">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <line x1="10" y1="9" x2="8" y2="9"/>
                    </svg>
                </button>
                <button class="tab-button icon-btn report-action-btn" id="exportHtmlButton" data-translate="export_interactive_html" style="display: none;" title="Export Interactive HTML">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="16 18 22 12 16 6"/>
                        <polyline points="8 6 2 12 8 18"/>
                    </svg>
                </button>
                <button class="tab-button icon-btn report-action-btn" id="copyMarkdownButton" data-translate="copy_markdown_report" style="display: none;" title="Copy Markdown Report">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                        <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                    </svg>
                </button>
            </div>
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('config')" data-translate="configuration">Configuration</button>
                <button class="tab-button" id="reportTab" onclick="showTab('report')" disabled data-translate="report">Report</button>
            </div>
        </div>
    </div>

    <!-- Configuration Tab -->
    <div id="configTab" class="tab-content active">
        <div class="config-container">
            
            <div class="section">
                <h2 data-translate="general_settings">General Settings</h2>
                <div class="form-group">
                    <label for="kerf_width" data-translate="kerf_width">Kerf Width (mm):</label>
                    <input type="number" id="kerf_width" name="kerf_width" step="0.1" min="0" max="10">
                </div>
                <div class="form-group">
                    <label for="allow_rotation">
                        <input type="checkbox" id="allow_rotation" name="allow_rotation"> <span data-translate="allow_rotation">Allow part rotation</span>
                    </label>
                </div>
            </div>
            
            <div class="section">
                <h2 data-translate="stock_materials_pricing">Stock Materials & Pricing</h2>
                <div class="materials-controls-single-row" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px;">
                    <button type="button" onclick="addMaterial()" class="material-icon-btn" title="Add Material">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
                    </button>
                    <button type="button" onclick="loadDefaults()" class="material-icon-btn" title="Load Defaults">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                    </button>
                    <button type="button" onclick="importCSV()" class="material-icon-btn" title="Import CSV">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    </button>
                    <button type="button" onclick="exportDatabase()" class="material-icon-btn" title="Export Database">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    </button>
                    <button type="button" id="foldToggle" onclick="toggleFold()" class="material-icon-btn" title="Toggle Used Materials Only">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                        <span class="visually-hidden">Toggle Used Materials Only</span>
                    </button>
                    <button type="button" onclick="clearHighlight()" class="material-icon-btn" title="Clear Highlight">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.67 1.33a2 2 0 0 0-2.83 0L13.5 6.67l-3.8-3.8a2 2 0 0 0-2.83 0L1.33 6.17a2 2 0 0 0 0 2.83l5.5 5.5c.39.39 1.02.39 1.41 0l3.8-3.8 5.83 5.83c.39.39 1.02.39 1.41 0l2.83-2.83a2 2 0 0 0 0-2.83z"/><path d="M2 19h10"/></svg>
                    </button>
                    <select id="sortBy" onchange="displayMaterials()" class="sort-select">
                        <option value="alphabetical">Sort: A-Z</option>
                        <option value="usage">Sort: Used First</option>
                        <option value="mostUsed">Sort: Most Used</option>
                    </select>
                </div>
                <div class="materials-header">
                    <span data-translate="material_name">Material Name</span>
                    <span data-translate="width_mm">Width (mm)</span>
                    <span data-translate="height_mm">Height (mm)</span>
                    <span data-translate="thickness_mm">Thickness (mm)</span>
                    <span data-translate="price">Price</span>
                    <span data-translate="actions">Actions</span>
                    <span data-translate="status">Status</span>
                </div>
                <div id="materials_list" class="materials-list"></div>
            </div>
            
            <div class="section">
                <h2 data-translate="parts_preview">Parts Preview</h2>
                <div id="parts_preview"></div>
            </div>
        </div>
    </div>

    <!-- Report Tab -->
    <div id="reportTabContent" class="tab-content">
        <div class="container">
            <div id="diagramsContainer" class="diagrams-container">
                <h2 data-translate="diagrams">Diagrams</h2>
                <p>Generate a report to view diagrams...</p>
            </div>
            <div class="resizer" id="resizer"></div>
            <div id="reportContainer" class="report-container">
                <div class="report-title">
                    <h2 data-translate="report_details">Report Details</h2>
                </div>
                
                <div id="globalTableControls" class="global-table-controls" style="position:fixed;top:60px;right:20px;width:280px;background:#fff;border:1px solid #ddd;border-radius:4px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,0.15);z-index:999;font-size:12px">
                    <h4 style="margin:0 0 10px 0;font-size:13px">Global Table Settings</h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
                        <div><label style="font-size:11px">Font:</label><select id="globalFontSize" onchange="applyGlobalTableSetting('fontSize', this.value)" style="width:100%;font-size:11px;padding:2px"><option value="12px">Small</option><option value="14px" selected>Normal</option><option value="16px">Large</option></select></div>
                        <div><label style="font-size:11px">Padding:</label><select id="globalCellPadding" onchange="applyGlobalTableSetting('cellPadding', this.value)" style="width:100%;font-size:11px;padding:2px"><option value="4px 8px">Compact</option><option value="8px 12px" selected>Normal</option><option value="12px 16px">Spacious</option></select></div>
                        <div><label style="font-size:11px">Header BG:</label><input type="color" id="globalHeaderBg" value="#f5f5f5" onchange="applyGlobalTableSetting('headerBg', this.value)" style="width:100%;height:24px;padding:0;border:1px solid #ccc"></div>
                        <div><label style="font-size:11px">Header Text:</label><input type="color" id="globalHeaderColor" value="#000000" onchange="applyGlobalTableSetting('headerColor', this.value)" style="width:100%;height:24px;padding:0;border:1px solid #ccc"></div>
                        <div><label style="font-size:11px">Row Hover:</label><input type="color" id="globalRowHover" value="#f6f8fa" onchange="applyGlobalTableSetting('rowHover', this.value)" style="width:100%;height:24px;padding:0;border:1px solid #ccc"></div>
                        <div><label style="font-size:11px">Text Align:</label><select id="globalTextAlign" onchange="applyGlobalTableSetting('textAlign', this.value)" style="width:100%;font-size:11px;padding:2px"><option value="left" selected>Left</option><option value="center">Center</option><option value="right">Right</option></select></div>
                        <div><label style="font-size:11px">Border:</label><select id="globalBorderWidth" onchange="applyGlobalTableSetting('borderWidth', this.value)" style="width:100%;font-size:11px;padding:2px"><option value="0px">None</option><option value="1px" selected>Light</option><option value="2px">Medium</option></select></div>
                        <div><label style="font-size:11px">Border Color:</label><input type="color" id="globalBorderColor" value="#d0d7de" onchange="applyGlobalTableSetting('borderColor', this.value)" style="width:100%;height:24px;padding:0;border:1px solid #ccc"></div>
                    </div>
                    <select id="globalVerticalAlign" onchange="applyGlobalTableSetting('verticalAlign', this.value)" style="display:none"><option value="middle" selected>Middle</option></select>
                    <select id="globalTextWrap" onchange="applyGlobalTableSetting('textWrap', this.value)" style="display:none"><option value="normal" selected>Wrap</option></select>
                    <select id="templateSelector" onchange="loadSelectedTemplate()" style="width:100%;font-size:11px;padding:2px;margin-bottom:8px"><option value="">Select Template...</option></select>
                    <div style="display:flex;gap:4px;flex-wrap:wrap">
                        <button onclick="applyAllGlobalSettings()" style="flex:1;font-size:11px;padding:4px 8px">Apply</button>
                        <button onclick="saveCurrentGlobalTemplate()" style="flex:1;font-size:11px;padding:4px 8px">Save</button>
                        <button onclick="resetAllTableSettings()" style="flex:1;font-size:11px;padding:4px 8px">Reset</button>
                        <button onclick="toggleGlobalTableSettings()" style="flex:1;font-size:11px;padding:4px 8px">Close</button>
                    </div>
                </div>
                
                <div class="section-separator"></div>
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                    <h2 data-translate="materials_used" style="margin:0">Materials Used</h2>
                    <div style="display:flex;gap:4px">
                        <button class="icon-btn" onclick="openTableCustomization('materialsUsedTable')" title="Customize Table">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <path d="M9 9h6v6H9z"/>
                                <path d="M9 3v6M15 3v6M21 9H3M21 15H3"/>
                            </svg>
                        </button>
                        <button class="icon-btn" onclick="copyTableAsMarkdown('materialsUsedTable')" title="Copy Markdown">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <table id="materialsUsedTable"></table>

                <div class="section-separator"></div>
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                    <h2 data-translate="overall_summary" style="margin:0">Overall Summary</h2>
                    <div style="display:flex;gap:4px">
                        <button class="icon-btn" onclick="openTableCustomization('summaryTable')" title="Customize Table">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <path d="M9 9h6v6H9z"/>
                                <path d="M9 3v6M15 3v6M21 9H3M21 15H3"/>
                            </svg>
                        </button>
                        <button class="icon-btn" onclick="copyTableAsMarkdown('summaryTable')" title="Copy Markdown">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <table id="summaryTable"></table>

                <div class="section-separator"></div>
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                    <h2 data-translate="unique_part_types" style="margin:0">Unique Part Types</h2>
                    <div style="display:flex;gap:4px">
                        <button class="icon-btn" onclick="openTableCustomization('uniquePartTypesTable')" title="Customize Table">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <path d="M9 9h6v6H9z"/>
                                <path d="M9 3v6M15 3v6M21 9H3M21 15H3"/>
                            </svg>
                        </button>
                        <button class="icon-btn" onclick="copyTableAsMarkdown('uniquePartTypesTable')" title="Copy Markdown">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <table id="uniquePartTypesTable"></table>

                <div class="section-separator"></div>
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                    <h2 style="margin:0">Sheet Inventory Summary</h2>
                    <div style="display:flex;gap:4px">
                        <button class="icon-btn" onclick="openTableCustomization('sheetInventoryTable')" title="Customize Table">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <path d="M9 9h6v6H9z"/>
                                <path d="M9 3v6M15 3v6M21 9H3M21 15H3"/>
                            </svg>
                        </button>
                        <button class="icon-btn" onclick="copyTableAsMarkdown('sheetInventoryTable')" title="Copy Markdown">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <table id="sheetInventoryTable"></table>
                
                <div class="section-separator"></div>
                <h2 data-translate="parts_placed_detailed">Cut List & Part Details</h2>
                <div class="tree-controls">
                    <button type="button" id="treeToggle" onclick="toggleTreeView()" data-translate="show_tree_structure">Show Tree Structure</button>
                    <div class="tree-search" id="treeSearchContainer" style="display: none;">
                        <input type="text" id="treeSearch" data-translate="search_components" placeholder="Search components..." oninput="filterTree()">
                        <button type="button" onclick="clearTreeSearch()" data-translate="clear">Clear</button>
                        <button type="button" onclick="expandAll()">Expand All</button>
                        <button type="button" onclick="collapseAll()">Collapse All</button>
                    </div>
                </div>
                <div id="treeStructure" class="tree-structure" style="display: none;"></div>
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                    <div style="display:flex;gap:4px">
                        <button class="icon-btn" onclick="openTableCustomization('partsTable')" title="Customize Table">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <path d="M9 9h6v6H9z"/>
                                <path d="M9 3v6M15 3v6M21 9H3M21 15H3"/>
                            </svg>
                        </button>
                        <button class="icon-btn" onclick="copyTableAsMarkdown('partsTable')" title="Copy Markdown">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <table id="partsTable"></table>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSettings()">&times;</span>

            <div class="settings-section">
                <h3>Units</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <select id="settingsUnits" class="sort-select">
                        <option value="mm">Millimeters (mm)</option>
                        <option value="cm">Centimeters (cm)</option>
                        <option value="m">Meters (m)</option>
                        <option value="in">Inches (in)</option>
                        <option value="ft">Feet (ft)</option>
                    </select>
                    <button onclick="updateUnits()" class="icon-btn" title="Update Units">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                            <path d="M21 3v5h-5"/>
                            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                            <path d="M3 21v-5h5"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="settings-section">
                <h3>Precision</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <select id="settingsPrecision" class="sort-select">
                        <option value="0">0</option>
                        <option value="1">0.0</option>
                        <option value="2">0.00</option>
                        <option value="3">0.000</option>
                    </select>
                    <button onclick="updatePrecision()" class="icon-btn" title="Update Precision">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                            <path d="M21 3v5h-5"/>
                            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                            <path d="M3 21v-5h5"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="settings-section">
                <h3>Area Units</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <select id="settingsAreaUnits" class="sort-select">
                        <option value="mm2">Square Millimeters (mm¬≤)</option>
                        <option value="cm2">Square Centimeters (cm¬≤)</option>
                        <option value="m2">Square Meters (m¬≤)</option>
                        <option value="in2">Square Inches (in¬≤)</option>
                        <option value="ft2">Square Feet (ft¬≤)</option>
                    </select>
                    <button onclick="updateAreaUnits()" class="icon-btn" title="Update Area Units">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                            <path d="M21 3v5h-5"/>
                            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                            <path d="M3 21v-5h5"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="settings-section">
                <h3>Default Currency</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <select id="settingsCurrency" class="sort-select">
                        <option value="USD">USD ($)</option>
                        <option value="EUR">EUR (‚Ç¨)</option>
                        <option value="SAR">SAR (ÿ±.ÿ≥)</option>
                        <option value="AED">AED (ÿØ.ÿ•)</option>
                        <option value="GBP">GBP (¬£)</option>
                    </select>
                    <button onclick="updateCurrency()" class="icon-btn" title="Update Currency">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                            <path d="M21 3v5h-5"/>
                            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                            <path d="M3 21v-5h5"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="settings-buttons">
                <button onclick="closeSettings()" class="primary">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal for enlarged part view -->
    <div id="partModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-controls">
                <button id="projectionToggle">Orthographic</button>
            </div>
            <canvas id="modalCanvas" width="500" height="400"></canvas>
            <div id="modalInfo"></div>
        </div>
    </div>

    <div id="tableCustomizationPanel" class="table-customization-panel" style="position:fixed;top:0;right:-300px;width:280px;height:100vh;background:#fff;border-left:1px solid #ddd;padding:12px;box-shadow:-2px 0 8px rgba(0,0,0,0.15);z-index:1000;transition:right 0.3s;overflow-y:auto;font-size:12px">
        <h4 id="panelTitle" style="margin:0 0 10px 0;font-size:13px">Table Settings</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
            <div><label style="font-size:11px">Font:</label><select id="tableFontSize" onchange="applyTableSetting('fontSize', this.value)" style="width:100%;font-size:11px;padding:2px"><option value="12px">Small</option><option value="14px" selected>Normal</option><option value="16px">Large</option></select></div>
            <div><label style="font-size:11px">Padding:</label><select id="tableCellPadding" onchange="applyTableSetting('cellPadding', this.value)" style="width:100%;font-size:11px;padding:2px"><option value="4px 8px">Compact</option><option value="8px 12px" selected>Normal</option><option value="12px 16px">Spacious</option></select></div>
            <div><label style="font-size:11px">Header BG:</label><input type="color" id="tableHeaderBg" value="#f5f5f5" onchange="applyTableSetting('headerBg', this.value)" style="width:100%;height:24px;padding:0;border:1px solid #ccc"></div>
            <div><label style="font-size:11px">Header Text:</label><input type="color" id="tableHeaderColor" value="#000000" onchange="applyTableSetting('headerColor', this.value)" style="width:100%;height:24px;padding:0;border:1px solid #ccc"></div>
            <div><label style="font-size:11px">Row Hover:</label><input type="color" id="tableRowHover" value="#f6f8fa" onchange="applyTableSetting('rowHover', this.value)" style="width:100%;height:24px;padding:0;border:1px solid #ccc"></div>
            <div><label style="font-size:11px">Text Align:</label><select id="tableTextAlign" onchange="applyTableSetting('textAlign', this.value)" style="width:100%;font-size:11px;padding:2px"><option value="left" selected>Left</option><option value="center">Center</option><option value="right">Right</option></select></div>
            <div><label style="font-size:11px">Border:</label><select id="tableBorderWidth" onchange="applyTableSetting('borderWidth', this.value)" style="width:100%;font-size:11px;padding:2px"><option value="0px">None</option><option value="1px" selected>Light</option><option value="2px">Medium</option></select></div>
            <div><label style="font-size:11px">Border Color:</label><input type="color" id="tableBorderColor" value="#d0d7de" onchange="applyTableSetting('borderColor', this.value)" style="width:100%;height:24px;padding:0;border:1px solid #ccc"></div>
        </div>
        <select id="tableVerticalAlign" onchange="applyTableSetting('verticalAlign', this.value)" style="display:none"><option value="middle" selected>Middle</option></select>
        <select id="tableTextWrap" onchange="applyTableSetting('textWrap', this.value)" style="display:none"><option value="normal" selected>Wrap</option></select>
        <input type="text" id="lowCostLabel" value="Budget" onchange="updateTextLabel('low', this.value)" style="display:none">
        <input type="text" id="avgCostLabel" value="Standard" onchange="updateTextLabel('avg', this.value)" style="display:none">
        <input type="text" id="highCostLabel" value="Premium" onchange="updateTextLabel('high', this.value)" style="display:none">
        <select id="individualTemplateSelector" onchange="loadIndividualTemplate()" style="width:100%;font-size:11px;padding:2px;margin-bottom:8px"><option value="">Select Template...</option></select>
        <div style="display:flex;gap:4px;flex-wrap:wrap">
            <button onclick="applyCurrentTableSettings()" style="flex:1;font-size:11px;padding:4px 8px">Apply</button>
            <button onclick="saveCurrentAsTemplate()" style="flex:1;font-size:11px;padding:4px 8px">Save</button>
            <button onclick="resetTableSettings()" style="flex:1;font-size:11px;padding:4px 8px">Reset</button>
            <button onclick="closeTableCustomization()" style="flex:1;font-size:11px;padding:4px 8px">Close</button>
        </div>
    </div>
    <div class="modal-overlay" onclick="closeTableCustomization()"></div>
    <div id="templateManagerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTemplateManager()">&times;</span>
            <h3>Template Manager</h3>
            <div class="template-categories">
                <button onclick="showTemplateCategory('predefined')">Built-in</button>
                <button onclick="showTemplateCategory('custom')">My Templates</button>
                <div id="predefinedTemplates" class="template-category active"><div id="predefinedTemplateGrid"></div></div>
                <div id="customTemplates" class="template-category"><input type="file" id="templateImportFile" accept=".json" style="display:none" onchange="importTemplateFile(this)"><button onclick="document.getElementById('templateImportFile').click()">Import</button><button onclick="exportAllTemplates()">Export All</button><div id="customTemplateGrid"></div></div>
            </div>
            <button onclick="closeTemplateManager()">Close</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="app.js"></script>
    <script src="diagrams_report.js"></script>
    <script src="table_customization.js"></script>
    <script src="resizer_fix.js"></script>
    <script>
        let currentReportData = null;

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tabs .tab-button').forEach(btn => btn.classList.remove('active'));
            
            // Configuration tab specific action buttons
            const configActionButtons = ['generateCutListButton', 'refreshSelectionButton', 'cancelButton'];
            // Report tab specific action buttons
            const reportActionButtons = ['refreshReportButton', 'printButton', 'exportCsvButton', 'exportHtmlButton', 'copyMarkdownButton'];

            configActionButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.style.display = (tabName === 'config') ? 'inline-flex' : 'none';
            });
            reportActionButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.style.display = (tabName === 'report') ? 'inline-flex' : 'none';
            });
            const globalTableBtn = document.getElementById('globalTableSettingsBtn');
            if (globalTableBtn) globalTableBtn.style.display = (tabName === 'report') ? 'inline-flex' : 'none';
            
            if (tabName === 'config') {
                document.getElementById('configTab').classList.add('active');
            } else if (tabName === 'report') {
                document.getElementById('reportTabContent').classList.add('active');
            }
            document.querySelector(`.tabs [onclick="showTab('${tabName}')"]`).classList.add('active');
        }

        function showReportTab(data) {
            console.log('showReportTab called with data:', data);
            
            document.getElementById('reportTab').disabled = false;
            currentReportData = data;
            
            // Ensure data structure is correct
            if (data && data.diagrams && data.report) {
                g_boardsData = data.diagrams;
                g_reportData = data.report;
                window.originalComponents = data.original_components || [];
                window.hierarchyTree = data.hierarchy_tree || [];
                
                console.log('Report data loaded:', g_reportData);
                console.log('Boards data loaded:', g_boardsData);
                
                // Render with delay to ensure DOM is ready
                setTimeout(() => {
                    if (typeof renderDiagrams === 'function') {
                        console.log('Calling renderDiagrams');
                        renderDiagrams();
                    }
                    if (typeof renderReport === 'function') {
                        console.log('Calling renderReport');
                        renderReport();
                    }
                }, 100);
                
                showTab('report');
                
                // Initialize export button event listeners only once
                initializeExportButtons();
                
                // Re-initialize resizer and table customization after showing report tab
                setTimeout(() => {
                    resizerInitialized = false;
                    initResizer();
                    if (typeof reinitializeTableCustomization === 'function') {
                        reinitializeTableCustomization();
                    }
                }, 200);
            } else {
                console.error('Invalid data structure received:', data);
                alert('Error: Invalid report data received. Please try generating the report again.');
            }
        }
        
        let exportButtonsInitialized = false;
        
        function initializeExportButtons() {
            if (exportButtonsInitialized) return;
            
            const printBtn = document.getElementById('printButton');
            const exportCsvBtn = document.getElementById('exportCsvButton');
            const exportHtmlBtn = document.getElementById('exportHtmlButton');
            
            if (printBtn) {
                printBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    exportToPDF();
                });
            }
            
            if (exportCsvBtn) {
                exportCsvBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (currentReportData && currentReportData.report) {
                        callRuby('export_csv', JSON.stringify(currentReportData.report));
                    } else {
                        alert('No report data available for export.');
                    }
                });
            }
            
            if (exportHtmlBtn) {
                exportHtmlBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof exportInteractiveHTML === 'function') {
                        exportInteractiveHTML();
                    } else {
                        alert('HTML export feature is not available.');
                    }
                });
            }
            
            const copyMarkdownBtn = document.getElementById('copyMarkdownButton');
            if (copyMarkdownBtn) {
                copyMarkdownBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    copyFullReportAsMarkdown();
                });
            }
            
            exportButtonsInitialized = true;
        }
        
        function exportToPDF() {
            const reportData = g_reportData;
            const boardsData = g_boardsData;
            
            if (!reportData || !boardsData) {
                alert('No report data available for PDF export.');
                return;
            }
            
            const reportUnits = window.currentUnits || 'mm';
            const reportPrecision = window.currentPrecision ?? 1;
            const currency = reportData.summary.currency || window.defaultCurrency || 'USD';
            const currencySymbol = window.currencySymbols[currency] || currency;
            const currentAreaUnitLabel = getAreaUnitLabel();
            
            const fullHTML = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AutoNestCut PDF Preview</title>
    <style>
        @page { size: A4; margin: 15mm; }
        @media print { .no-print { display: none !important; } }
        body { margin: 0; padding: 0; background: #f0f0f0; font-family: Arial, sans-serif; }
        .preview-header {
            position: fixed; top: 0; left: 0; right: 0; background: #007cba; color: white;
            padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000;
        }
        .preview-header h2 { margin: 0; font-size: 18px; }
        .preview-buttons { display: flex; gap: 10px; }
        .preview-buttons button {
            padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;
            font-size: 14px; font-weight: 600; transition: all 0.2s;
        }
        .btn-export { background: #28a745; color: white; }
        .btn-export:hover { background: #218838; }
        .btn-close { background: #dc3545; color: white; }
        .btn-close:hover { background: #c82333; }
        .pdf-container { margin-top: 70px; padding: 20px; display: flex; justify-content: center; }
        .pdf-content { max-width: 210mm; background: white; padding: 20mm; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="preview-header no-print">
        <h2>üìÑ PDF Preview - AutoNestCut Report</h2>
        <div class="preview-buttons">
            <button class="btn-export" onclick="window.print()">üñ®Ô∏è Export to PDF</button>
            <button class="btn-close" onclick="window.close()">‚úñ Close</button>
        </div>
    </div>
    <div class="pdf-container">
        <div class="pdf-content">
            <div style="font-family: Arial, sans-serif; color: black;">
                <!-- Header -->
                <div style="text-align: center; border-bottom: 3px solid #007cba; padding-bottom: 20px; margin-bottom: 30px;">
                    <h1 style="color: #007cba; margin: 0; font-size: 28px;">AutoNestCut Report</h1>
                    <p style="margin: 5px 0; color: #666; font-size: 14px;">Professional Cut List & Nesting Analysis</p>
                    <p style="margin: 5px 0; color: #666; font-size: 12px;">Generated: ${new Date().toLocaleString()}</p>
                </div>
                
                <!-- Executive Summary -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                    <h2 style="color: #007cba; margin-top: 0;">Executive Summary</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <p><strong>Total Parts:</strong> ${reportData.summary.total_parts_instances || 0}</p>
                            <p><strong>Unique Types:</strong> ${reportData.summary.total_unique_part_types || 0}</p>
                            <p><strong>Boards Required:</strong> ${reportData.summary.total_boards || 0}</p>
                        </div>
                        <div>
                            <p><strong>Material Efficiency:</strong> ${formatNumber(reportData.summary.overall_efficiency || 0, 1)}%</p>
                            <p><strong>Total Project Cost:</strong> ${currencySymbol}${(reportData.summary.total_project_cost || 0).toFixed(2)}</p>
                            <p><strong>Waste Percentage:</strong> ${formatNumber(reportData.summary.overall_waste_percentage || 0, 1)}%</p>
                        </div>
                    </div>
                </div>
                
                <!-- Part Types Table -->
                <div style="margin-bottom: 30px;">
                    <h2 style="color: #007cba;">Part Types Summary</h2>
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: #007cba; color: white;">
                                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Name</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">W (${reportUnits})</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">H (${reportUnits})</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Thick (${reportUnits})</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Material</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Grain</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Edge Banding</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Qty</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Total Area (${currentAreaUnitLabel})</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(reportData.unique_part_types || []).map(part => {
                                const width = part.width / window.unitFactors[reportUnits];
                                const height = part.height / window.unitFactors[reportUnits];
                                const thickness = part.thickness / window.unitFactors[reportUnits];
                                return `
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td style="padding: 8px; border: 1px solid #ddd;">${part.name}</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${formatNumber(width, reportPrecision)}</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${formatNumber(height, reportPrecision)}</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${formatNumber(thickness, reportPrecision)}</td>
                                    <td style="padding: 8px; border: 1px solid #ddd;">${part.material}</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${part.grain_direction || 'Any'}</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${part.edge_banding || 'None'}</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd; font-weight: bold;">${part.total_quantity}</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${formatAreaForPDF(part.total_area)}</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <!-- Boards Summary -->
                <div style="margin-bottom: 30px;">
                    <h2 style="color: #007cba;">Board Layout Summary</h2>
                    ${boardsData.map((board, index) => {
                        const width = board.stock_width / window.unitFactors[reportUnits];
                        const height = board.stock_height / window.unitFactors[reportUnits];
                        return `
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f9f9f9;">
                            <h3 style="margin-top: 0; color: #007cba;">${board.material} - Board ${index + 1}</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 12px;">
                                <div><strong>Size:</strong> ${formatNumber(width, reportPrecision)} √ó ${formatNumber(height, reportPrecision)} ${reportUnits}</div>
                                <div><strong>Parts:</strong> ${board.parts ? board.parts.length : 0}</div>
                                <div><strong>Efficiency:</strong> ${board.efficiency_percentage ? board.efficiency_percentage.toFixed(1) : 0}%</div>
                            </div>
                            ${board.parts && board.parts.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong>Parts on this board:</strong>
                                <ul style="margin: 5px 0; padding-left: 20px; font-size: 11px;">
                                    ${board.parts.map(part => {
                                        const partW = part.width / window.unitFactors[reportUnits];
                                        const partH = part.height / window.unitFactors[reportUnits];
                                        let partInfo = `${part.name}: ${formatNumber(partW, reportPrecision)}√ó${formatNumber(partH, reportPrecision)}`;
                                        if (part.edge_banding && part.edge_banding !== 'None') partInfo += ` (${part.edge_banding})`;
                                        if (part.grain_direction && part.grain_direction !== 'Any') partInfo += ` [${part.grain_direction}]`;
                                        return `<li>${partInfo}</li>`;
                                    }).join('')}
                                </ul>
                            </div>` : ''}
                        </div>`;
                    }).join('')}
                </div>
                
                <!-- Cost Analysis (if still needed, render directly without the problem container) -->
                ${reportData.unique_board_types ? `
                <div style="margin-bottom: 30px;">
                    <h2 style="color: #007cba;">Cost Analysis</h2>
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: #007cba; color: white;">
                                <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Material</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Sheets</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Price/Sheet</th>
                                <th style="padding: 10px; text-align: center; border: 1px solid #ddd;">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reportData.unique_board_types.map(board => {
                                const boardCurrency = board.currency || currency;
                                const boardSymbol = window.currencySymbols[boardCurrency] || boardCurrency;
                                return `
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <td style="padding: 8px; border: 1px solid #ddd;">${board.material}</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${board.count}</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${boardSymbol}${(board.price_per_sheet || 0).toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: center; border: 1px solid #ddd; font-weight: bold;">${boardSymbol}${(board.total_cost || 0).toFixed(2)}</td>
                                </tr>`;
                            }).join('')}
                            <tr style="background: #e8f5e8; font-weight: bold;">
                                <td colspan="3" style="padding: 10px; text-align: right; border: 1px solid #ddd;">TOTAL PROJECT COST:</td>
                                <td style="padding: 10px; text-align: center; border: 1px solid #ddd; color: #22863a; font-size: 14px;">${currencySymbol}${(reportData.summary.total_project_cost || 0).toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>` : ''}
                
                <!-- Footer -->
                <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 10px; color: #666;">
                    <p>Generated by AutoNestCut v2.7.0 - Professional Cut List & Nesting Software</p>
                    <p>Report generated on ${new Date().toLocaleString()}</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>`;
            
            if (typeof callRuby === 'function') {
                callRuby('print_pdf', fullHTML);
            } else {
                alert('Print function not available');
            }
        }

        function showError(message) {
            console.error('Error:', message);
            alert(message);
        }
        
        function showProgressOverlay(message) {
            const overlay = document.createElement('div');
            overlay.id = 'progressOverlay';
            overlay.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #007cba; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
                    <div id="progressMessage" style="background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; margin-bottom: 10px;">${message}</div>
                    <div id="progressPercent" style="background: rgba(0,0,0,0.8); color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; margin-bottom: 15px;">0%</div>
                    <button onclick="cancelProcessing()" style="background: #ff4444; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer;">Cancel</button>
                </div>
                <style>
                    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                </style>
            `;
            document.body.appendChild(overlay);
        }
        
        function updateProgressOverlay(message, percentage) {
            const messageEl = document.getElementById('progressMessage');
            const percentEl = document.getElementById('progressPercent');
            
            if (messageEl) messageEl.textContent = message;
            if (percentEl) percentEl.textContent = percentage + '%';
        }
        
        function hideProgressOverlay() {
            const overlay = document.getElementById('progressOverlay');
            if (overlay) overlay.remove();
        }
        
        function cancelProcessing() {
            callRuby('cancel_processing');
            hideProgressOverlay();
        }
        
        function refreshConfiguration() {
            callRuby('refresh_config');
        }
        
        function refreshReport() {
            callRuby('refresh_report');
        }
        
        function refreshReportWithFeedback() {
            // Clear cached nesting results to force recalculation with new kerf
            if (typeof g_boardsData !== 'undefined') {
                callRuby('clear_nesting_cache');
            }
            refreshReport();
        }
        
        function receiveRefreshedData(data) {
            // Update the configuration with refreshed data
            receiveInitialData(data);
        }
        
        function refreshReportWithCurrentSettings() {
            // Get current settings from the form
            const settings = getCurrentSettings();
            if (settings) {
                // Re-process with current settings
                callRuby('process', JSON.stringify(settings));
            }
        }
        
        function showConfigTab() {
            showTab('config');
        }
        
        let showTreeView = false;
        
        function toggleTreeView() {
            showTreeView = !showTreeView;
            const button = document.getElementById('treeToggle');
            const treeContainer = document.getElementById('treeStructure');
            const searchContainer = document.getElementById('treeSearchContainer');
            
            if (showTreeView) {
                button.textContent = 'Hide Tree Structure';
                treeContainer.style.display = 'block';
                searchContainer.style.display = 'flex';
            } else {
                button.textContent = 'Show Tree Structure';
                treeContainer.style.display = 'none';
                searchContainer.style.display = 'none';
            }
        }

        // --- NEW --- Placeholder for copyTableAsMarkdown function.
        // This will be properly implemented in app.js/diagrams_report.js later.
        // This function is now defined in diagrams_report.js and included there.
        // This blank function prevents errors if called before diagrams_report.js loads.
        function copyTableAsMarkdown(tableId) {
            console.log(`Attempting to copy table: ${tableId}`);
            // Actual implementation is in diagrams_report.js
        }
        
        // Function to format area for PDF output where unit is in the header
        function formatAreaForPDF(areaInMm2) {
            const factor = areaFactors[window.currentAreaUnits || 'm2']; // Default to m2 if not set
            const convertedArea = areaInMm2 / factor;
            return formatNumber(convertedArea, currentPrecision); // Use current precision
        }


        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {

            const modal = document.getElementById('partModal');
            const closeBtns = document.querySelectorAll('#partModal .close');
            
            closeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    modal.style.display = 'none';
                });
            });
            
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });

            // Initialize resizer with a delay to ensure DOM is ready
            setTimeout(() => {
                initResizer();
            }, 100);
            callRuby('ready');
            
            // Set "Used Only" toggle to ON by default for materials
            // The actual filtering logic will be in app.js/displayMaterials
            const foldToggle = document.getElementById('foldToggle');
            if (foldToggle) {
                if (showOnlyUsed) { // showOnlyUsed is initialized to true in app.js
                    // Call toggleFold to set initial visual state and filter
                    toggleFold();
                }
            }
        });
    </script>
</body>
</html>
