<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoNestCut Interactive Report</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            color: #24292e;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-size: 14px;
        }
        .header {
            background: #ffffff;
            color: #24292e;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #d0d7de;
            height: 56px;
        }
        .header h1 {
            font-size: 18px;
            margin: 0;
            color: #24292e;
            font-weight: 600;
        }
        button {
            background: #24292e;
            color: #ffffff;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 8px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.15s;
        }
        button:hover {
            background: #1c2128;
        }
        .container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }
        .diagrams-container {
            flex: 1 1 auto;
            min-width: 300px;
            padding: 16px;
            background-color: #ffffff;
            border-right: 1px solid #d0d7de;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 16px;
            resize: horizontal;
        }
        .report-container {
            flex: 1 1 auto;
            min-width: 400px;
            padding: 16px;
            background-color: #ffffff;
            overflow-y: auto;
            overflow-x: auto;
        }
        .resizer {
            width: 4px;
            background: #d0d7de;
            cursor: col-resize;
            user-select: none;
            flex-shrink: 0;
            transition: background 0.15s;
        }
        .resizer:hover {
            background: #24292e;
        }
        .diagram-card {
            border: 1px solid #d0d7de;
            padding: 12px;
            background-color: #ffffff;
            border-radius: 6px;
            flex: 0 0 auto;
            width: 100%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .diagram-card h3 {
            font-size: 16px;
            margin-bottom: 6px;
            color: #24292e;
            font-weight: 600;
        }
        .diagram-card p {
            font-size: 14px;
            color: #656d76;
            margin-bottom: 12px;
        }
        .diagram-canvas {
            border: 1px solid #d0d7de;
            display: block;
            background-color: #ffffff;
            width: 100%;
            height: auto;
            border-radius: 4px;
        }
        table {
            border-collapse: collapse;
            margin-bottom: 16px;
            font-size: 14px;
            width: 100%;
            background: #ffffff;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            overflow: hidden;
        }
        th, td {
            border-bottom: 1px solid #d0d7de;
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background-color: #f6f8fa;
            font-weight: 600;
            color: #24292e;
            font-size: 14px;
        }
        tbody tr:hover {
            background: #f6f8fa;
        }
        h2 {
            margin-top: 24px;
            margin-bottom: 12px;
            color: #24292e;
            font-size: 16px;
            font-weight: 600;
            padding-bottom: 6px;
            border-bottom: 1px solid #d0d7de;
        }
        .material-item {
            display: inline-flex;
            align-items: center;
            margin: 4px 6px 4px 0;
            padding: 6px 10px;
            background: #f6f8fa;
            border-radius: 4px;
            border: 1px solid #d0d7de;
            cursor: pointer;
            font-size: 14px;
        }
        .material-swatch {
            width: 16px;
            height: 16px;
            border: 1px solid #d0d7de;
            margin-right: 6px;
            border-radius: 3px;
        }
        .material-name {
            font-size: 14px;
            font-weight: 500;
        }
        .material-price {
            font-size: 12px;
            color: #656d76;
            margin-left: 8px;
            font-weight: normal;
        }
        .total-highlight {
            background-color: #f6ffed !important;
            font-weight: 600;
            color: #22863a;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #d0d7de;
            width: 520px;
            max-width: 90%;
            max-height: 80vh;
            border-radius: 6px;
            text-align: center;
            overflow-y: auto;
        }
        .close {
            color: #656d76;
            float: right;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .close:hover, .close:focus {
            color: #24292e;
        }
        #modalCanvas {
            border: 1px solid #d0d7de;
            margin: 12px 0;
            border-radius: 4px;
        }
        #modalInfo {
            text-align: left;
            margin-top: 15px;
        }
        #modalInfo h3 {
            margin-top: 0;
            color: #24292e;
            font-size: 16px;
        }
        #modalInfo p {
            margin: 6px 0;
            color: #656d76;
            font-size: 14px;
        }
        .modal-controls {
            text-align: center;
            margin-bottom: 10px;
        }
        .modal-controls button {
            margin: 0 6px;
            padding: 8px 12px;
            background: #24292e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .modal-controls button:hover {
            background: #1c2128;
        }
        .part-label-cell,
        .part-dimensions-cell {
            cursor: pointer;
            text-decoration: underline;
            color: #24292e;
            transition: all 0.15s ease;
        }
        .part-label-cell:hover,
        .part-dimensions-cell:hover {
            background-color: #f6f8fa !important;
            font-weight: 600;
        }
        @media print {
            @page { margin: 0.75in; size: letter; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            body { font-family: Arial, sans-serif; font-size: 11pt; line-height: 1.3; margin: 0; padding: 0; background: white; color: black; display: block; height: auto; }
            .header { text-align: center; background: none; color: black; border-bottom: 2pt solid #333; margin-bottom: 20pt; padding: 15pt 0; }
            .header h1 { font-size: 20pt; font-weight: bold; margin: 0; color: #333; }
            button, .resizer { display: none !important; }
            .container { display: block; width: 100%; }
            .diagrams-container { display: block; width: 100%; margin-bottom: 30pt; page-break-after: always; }
            .report-container { display: block; width: 100%; margin: 0; padding: 0; }
            .diagram-card { page-break-inside: avoid; margin-bottom: 20pt; border: 1pt solid #333; padding: 12pt; background: white; text-align: center; }
            .diagram-card h3 { font-size: 14pt; font-weight: bold; margin: 0 0 8pt 0; color: #333; }
            .diagram-card p { font-size: 10pt; margin: 0 0 12pt 0; color: #666; }
            .diagram-canvas { max-width: 100%; height: auto; border: 1pt solid #666; background: white; }
            h2 { font-size: 16pt; font-weight: bold; margin: 25pt 0 12pt 0; color: #333; border-bottom: 1pt solid #333; padding-bottom: 6pt; page-break-after: avoid; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 20pt; font-size: 9pt; page-break-inside: auto; }
            th, td { border: 1pt solid #333; padding: 6pt 8pt; text-align: left; vertical-align: top; }
            th { background: #e8e8e8; font-weight: bold; font-size: 10pt; }
            tr { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>AutoNestCut Interactive Report</h1>
        <button onclick="window.print()">Print / Save as PDF</button>
    </div>
    <div class="container">
        <div id="diagramsContainer" class="diagrams-container"></div>
        <div class="resizer" id="resizer"></div>
        <div id="reportContainer" class="report-container">
            <h2>Overall Summary</h2>
            <table id="summaryTable"></table>
            <h2>Materials Used</h2>
            <div id="materialsContainer"></div>
            <h2>Unique Part Types</h2>
            <table id="uniquePartTypesTable"></table>
            <h2>Unique Board Types</h2>
            <table id="uniqueBoardTypesTable"></table>
            <h2>Boards Summary</h2>
            <table id="boardsTable"></table>
            <h2>Parts Placed (Detailed)</h2>
            <table id="partsTable"></table>
        </div>
    </div>
    <div id="partModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-controls">
                <button id="projectionToggle">Orthographic</button>
            </div>
            <canvas id="modalCanvas" width="500" height="400"></canvas>
            <div id="modalInfo"></div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script>
        // Embedded data - CRITICAL: Must be valid JSON
        let g_boardsData = [{"material":"0053_Ivory","stock_width":2440,"stock_height":1220,"parts_count":5,"used_area":2137440.0000000014,"waste_area":839359.9999999986,"waste_percentage":28.2,"efficiency_percentage":71.8,"parts":[{"name":"Group#7","width":500,"height":915,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","area":457500,"x":0,"y":0,"rotated":false,"instance_id":"P1","texture_data":null},{"name":"Group#88","width":500,"height":915,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","area":457500,"x":510,"y":0,"rotated":false,"instance_id":"P2","texture_data":null},{"name":"Group#6","width":500,"height":915,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","area":457500,"x":1020,"y":0,"rotated":false,"instance_id":"P3","texture_data":null},{"name":"Group#89","width":418,"height":915,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","area":382470,"x":1530,"y":0,"rotated":false,"instance_id":"P4","texture_data":null},{"name":"Group#5","width":418,"height":915,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","area":382470,"x":1960,"y":0,"rotated":false,"instance_id":"P5","texture_data":null}]},{"material":"0053_Ivory","stock_width":2440,"stock_height":1220,"parts_count":9,"used_area":2134539.9999999916,"waste_area":842260.0000000084,"waste_percentage":28.29,"efficiency_percentage":71.71000000000001,"parts":[{"name":"Group#12","width":300,"height":890,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","area":267000,"x":0,"y":0,"rotated":false,"instance_id":"P6","texture_data":null},{"name":"Group#11","width":300,"height":890,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","area":267000,"x":310,"y":0,"rotated":false,"instance_id":"P7","texture_data":null},{"name":"Group#96","width":300,"height":890,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","area":267000,"x":620,"y":0,"rotated":false,"instance_id":"P8","texture_data":null},{"name":"Group#13","width":426,"height":615,"thickness":20,"material":"0053_Ivory","grain_direction":"any","area":261990,"x":930,"y":0,"rotated":false,"instance_id":"P9","texture_data":null},{"name":"Group#8","width":426,"height":615,"thickness":20,"material":"0053_Ivory","grain_direction":"any","area":261990,"x":1360,"y":0,"rotated":false,"instance_id":"P10","texture_data":null},{"name":"Group#109","width":426,"height":615,"thickness":20,"material":"0053_Ivory","grain_direction":"any","area":261990,"x":1790,"y":0,"rotated":false,"instance_id":"P11","texture_data":null},{"name":"Group#10","width":615,"height":418,"thickness":20,"material":"0053_Ivory","grain_direction":"any","area":257070,"x":930,"y":620,"rotated":true,"instance_id":"P12","texture_data":null},{"name":"Group#14","width":350,"height":415,"thickness":20,"material":"0053_Ivory","grain_direction":"any","area":145250,"x":1550,"y":620,"rotated":false,"instance_id":"P13","texture_data":null},{"name":"Group#108","width":350,"height":415,"thickness":20,"material":"0053_Ivory","grain_direction":"any","area":145250,"x":1910,"y":620,"rotated":false,"instance_id":"P14","texture_data":null}]},{"material":"0053_Ivory","stock_width":2440,"stock_height":1220,"parts_count":1,"used_area":245999.9999999999,"waste_area":2730800,"waste_percentage":91.74,"efficiency_percentage":8.260000000000005,"parts":[{"name":"Group#107","width":400,"height":615,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","area":246000,"x":0,"y":0,"rotated":false,"instance_id":"P15","texture_data":null}]},{"material":"Sheet_Material","stock_width":2440,"stock_height":1220,"parts_count":2,"used_area":251043.69360000017,"waste_area":2725756.3063999997,"waste_percentage":91.57,"efficiency_percentage":8.430000000000007,"parts":[{"name":"Group#4","width":281.4,"height":446.06,"thickness":20,"material":"Sheet_Material","grain_direction":"vertical","area":125521.85,"x":0,"y":0,"rotated":false,"instance_id":"P16","texture_data":null},{"name":"Group#111","width":281.4,"height":446.06,"thickness":20,"material":"Sheet_Material","grain_direction":"vertical","area":125521.85,"x":290,"y":0,"rotated":false,"instance_id":"P17","texture_data":null}]}];
        let g_reportData = {"parts_placed":[{"part_unique_id":"P1","name":"Group#7","width":500,"height":915,"thickness":20,"material":"0053_Ivory","area":457500,"board_number":1,"position_x":0,"position_y":0,"rotated":"No","grain_direction":"vertical"},{"part_unique_id":"P2","name":"Group#88","width":500,"height":915,"thickness":20,"material":"0053_Ivory","area":457500,"board_number":1,"position_x":510,"position_y":0,"rotated":"No","grain_direction":"vertical"},{"part_unique_id":"P3","name":"Group#6","width":500,"height":915,"thickness":20,"material":"0053_Ivory","area":457500,"board_number":1,"position_x":1020,"position_y":0,"rotated":"No","grain_direction":"vertical"},{"part_unique_id":"P4","name":"Group#89","width":418,"height":915,"thickness":20,"material":"0053_Ivory","area":382470,"board_number":1,"position_x":1530,"position_y":0,"rotated":"No","grain_direction":"vertical"},{"part_unique_id":"P5","name":"Group#5","width":418,"height":915,"thickness":20,"material":"0053_Ivory","area":382470,"board_number":1,"position_x":1960,"position_y":0,"rotated":"No","grain_direction":"vertical"},{"part_unique_id":"P6","name":"Group#12","width":300,"height":890,"thickness":20,"material":"0053_Ivory","area":267000,"board_number":2,"position_x":0,"position_y":0,"rotated":"No","grain_direction":"vertical"},{"part_unique_id":"P7","name":"Group#11","width":300,"height":890,"thickness":20,"material":"0053_Ivory","area":267000,"board_number":2,"position_x":310,"position_y":0,"rotated":"No","grain_direction":"vertical"},{"part_unique_id":"P8","name":"Group#96","width":300,"height":890,"thickness":20,"material":"0053_Ivory","area":267000,"board_number":2,"position_x":620,"position_y":0,"rotated":"No","grain_direction":"vertical"},{"part_unique_id":"P9","name":"Group#13","width":426,"height":615,"thickness":20,"material":"0053_Ivory","area":261990,"board_number":2,"position_x":930,"position_y":0,"rotated":"No","grain_direction":"any"},{"part_unique_id":"P10","name":"Group#8","width":426,"height":615,"thickness":20,"material":"0053_Ivory","area":261990,"board_number":2,"position_x":1360,"position_y":0,"rotated":"No","grain_direction":"any"},{"part_unique_id":"P11","name":"Group#109","width":426,"height":615,"thickness":20,"material":"0053_Ivory","area":261990,"board_number":2,"position_x":1790,"position_y":0,"rotated":"No","grain_direction":"any"},{"part_unique_id":"P12","name":"Group#10","width":615,"height":418,"thickness":20,"material":"0053_Ivory","area":257070,"board_number":2,"position_x":930,"position_y":620,"rotated":"Yes","grain_direction":"any"},{"part_unique_id":"P13","name":"Group#14","width":350,"height":415,"thickness":20,"material":"0053_Ivory","area":145250,"board_number":2,"position_x":1550,"position_y":620,"rotated":"No","grain_direction":"any"},{"part_unique_id":"P14","name":"Group#108","width":350,"height":415,"thickness":20,"material":"0053_Ivory","area":145250,"board_number":2,"position_x":1910,"position_y":620,"rotated":"No","grain_direction":"any"},{"part_unique_id":"P15","name":"Group#107","width":400,"height":615,"thickness":20,"material":"0053_Ivory","area":246000,"board_number":3,"position_x":0,"position_y":0,"rotated":"No","grain_direction":"vertical"},{"part_unique_id":"P16","name":"Group#4","width":281.4,"height":446.06,"thickness":20,"material":"Sheet_Material","area":125521.85,"board_number":4,"position_x":0,"position_y":0,"rotated":"No","grain_direction":"vertical"},{"part_unique_id":"P17","name":"Group#111","width":281.4,"height":446.06,"thickness":20,"material":"Sheet_Material","area":125521.85,"board_number":4,"position_x":290,"position_y":0,"rotated":"No","grain_direction":"vertical"}],"unique_part_types":[{"name":"Group#10","width":615,"height":418,"thickness":20,"material":"0053_Ivory","grain_direction":"any","total_quantity":1,"total_area":257069.99999999977},{"name":"Group#107","width":400,"height":615,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","total_quantity":1,"total_area":245999.9999999999},{"name":"Group#108","width":350,"height":415,"thickness":20,"material":"0053_Ivory","grain_direction":"any","total_quantity":1,"total_area":145249.99999999962},{"name":"Group#109","width":426,"height":615,"thickness":20,"material":"0053_Ivory","grain_direction":"any","total_quantity":1,"total_area":261989.99999999767},{"name":"Group#11","width":300,"height":890,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","total_quantity":1,"total_area":266999.99999999994},{"name":"Group#111","width":281.4,"height":446.06,"thickness":20,"material":"Sheet_Material","grain_direction":"vertical","total_quantity":1,"total_area":125521.84680000009},{"name":"Group#12","width":300,"height":890,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","total_quantity":1,"total_area":266999.99999999994},{"name":"Group#13","width":426,"height":615,"thickness":20,"material":"0053_Ivory","grain_direction":"any","total_quantity":1,"total_area":261989.99999999767},{"name":"Group#14","width":350,"height":415,"thickness":20,"material":"0053_Ivory","grain_direction":"any","total_quantity":1,"total_area":145249.99999999962},{"name":"Group#4","width":281.4,"height":446.06,"thickness":20,"material":"Sheet_Material","grain_direction":"vertical","total_quantity":1,"total_area":125521.84680000009},{"name":"Group#5","width":418,"height":915,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","total_quantity":1,"total_area":382470.00000000023},{"name":"Group#6","width":500,"height":915,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","total_quantity":1,"total_area":457500.0000000003},{"name":"Group#7","width":500,"height":915,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","total_quantity":1,"total_area":457500.0000000003},{"name":"Group#8","width":426,"height":615,"thickness":20,"material":"0053_Ivory","grain_direction":"any","total_quantity":1,"total_area":261989.99999999767},{"name":"Group#88","width":500,"height":915,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","total_quantity":1,"total_area":457500.0000000003},{"name":"Group#89","width":418,"height":915,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","total_quantity":1,"total_area":382470.00000000023},{"name":"Group#96","width":300,"height":890,"thickness":20,"material":"0053_Ivory","grain_direction":"vertical","total_quantity":1,"total_area":266999.99999999994}],"unique_board_types":[{"material":"0053_Ivory","dimensions":"2440.0 x 1220.0mm","count":3,"total_area":8930400,"price_per_sheet":0,"total_cost":0},{"material":"Sheet_Material","dimensions":"2440.0 x 1220.0mm","count":1,"total_area":2976800,"price_per_sheet":445,"total_cost":445}],"boards":[{"board_number":1,"material":"0053_Ivory","stock_size":"2440.0mm x 1220.0mm","parts_count":5,"used_area":2137440,"waste_area":839360,"waste_percentage":28.2,"efficiency":71.8},{"board_number":2,"material":"0053_Ivory","stock_size":"2440.0mm x 1220.0mm","parts_count":9,"used_area":2134540,"waste_area":842260,"waste_percentage":28.29,"efficiency":71.71000000000001},{"board_number":3,"material":"0053_Ivory","stock_size":"2440.0mm x 1220.0mm","parts_count":1,"used_area":246000,"waste_area":2730800,"waste_percentage":91.74,"efficiency":8.260000000000005},{"board_number":4,"material":"Sheet_Material","stock_size":"2440.0mm x 1220.0mm","parts_count":2,"used_area":251043.69,"waste_area":2725756.31,"waste_percentage":91.57,"efficiency":8.430000000000007}],"summary":{"total_parts_instances":17,"total_unique_part_types":17,"total_boards":4,"total_stock_area":11907200,"total_used_area":4769023.69,"total_waste_area":7138176.31,"overall_waste_percentage":59.95,"overall_efficiency":40.05,"total_project_cost":445}};
        
        // All functions embedded below
        
        let scene, camera, renderer, controls, cube;
        let showTexture = false, isOrthographic = false, currentPart = null;
        let currentHighlightedPiece = null;
        let currentHighlightedCanvas = null;
        
        // Calculate total project cost from unique board types
        function calculateTotalProjectCost() {
            if (!g_reportData || !g_reportData.unique_board_types) return 0;
            return g_reportData.unique_board_types.reduce((sum, board) => sum + (board.total_cost || 0), 0);
        }
        
        // Calculate overall efficiency from total areas
        function calculateOverallEfficiency() {
            if (!g_reportData || !g_reportData.unique_board_types || !g_reportData.unique_part_types) return 0;
            const totalPartsArea = g_reportData.unique_part_types.reduce((sum, part) => sum + (part.total_area || 0), 0);
            const totalBoardsArea = g_reportData.unique_board_types.reduce((sum, board) => sum + (board.total_area || 0), 0);
            if (totalBoardsArea === 0) return 0;
            return (totalPartsArea / totalBoardsArea) * 100;
        }
        
        function getMaterialColor(material) {
    let hash = 0;
    for (let i = 0; i < material.length; i++) {
        hash = material.charCodeAt(i) + ((hash << 5) - hash);
    }
    const hue = Math.abs(hash) % 360;
    return `hsl(${hue}, 45%, 65%)`;
}
        
        function getMaterialTexture(material) {
    if (material.toLowerCase().includes('wood') || material.toLowerCase().includes('chestnut')) {
        return 'repeating-linear-gradient(45deg, #8B4513, #8B4513 2px, #A0522D 2px, #A0522D 4px)';
    } else if (material.includes('240,240,240')) {
        return 'repeating-linear-gradient(90deg, #f0f0f0, #f0f0f0 3px, #e0e0e0 3px, #e0e0e0 6px)';
    }
    return getMaterialColor(material);
}
        
        function renderDiagrams() {
    const container = document.getElementById('diagramsContainer');
    container.innerHTML = '';

    if (!g_boardsData || g_boardsData.length === 0) {
        container.innerHTML = '<p>No cutting diagrams to display.</p>';
        return;
    }

    g_boardsData.forEach((board, boardIndex) => {
        const card = document.createElement('div');
        card.className = 'diagram-card';

        const title = document.createElement('h3');
        title.textContent = `${board.material} Board ${boardIndex + 1}`;
        title.id = `diagram-${board.material.replace(/[^a-zA-Z0-9]/g, '_')}-${boardIndex}`;
        card.appendChild(title);

        const info = document.createElement('p');
        info.innerHTML = `Size: ${board.stock_width.toFixed(1)}x${board.stock_height.toFixed(1)}mm<br>
                          Waste: ${board.waste_percentage.toFixed(1)}% (Efficiency: ${board.efficiency_percentage.toFixed(1)}%)`;
        card.appendChild(info);

        const canvas = document.createElement('canvas');
        canvas.className = 'diagram-canvas';
        card.appendChild(canvas);

        container.appendChild(card);

        const ctx = canvas.getContext('2d');
        const padding = 40;
        const maxCanvasDim = 600;
        const scale = Math.min(
            (maxCanvasDim - 2 * padding) / board.stock_width,
            (maxCanvasDim - 2 * padding) / board.stock_height
        );

        canvas.width = board.stock_width * scale + 2 * padding;
        canvas.height = board.stock_height * scale + 2 * padding;

        ctx.fillStyle = '#f5f5f5';
        ctx.fillRect(padding, padding, board.stock_width * scale, board.stock_height * scale);
        ctx.strokeStyle = '#666';
        ctx.lineWidth = 2;
        ctx.strokeRect(padding, padding, board.stock_width * scale, board.stock_height * scale);
        
        ctx.fillStyle = '#333';
        ctx.font = `${Math.max(12, 14 * scale)}px Arial`;
        ctx.textAlign = 'center';
        ctx.fillText(`${board.stock_width.toFixed(0)}mm`, padding + (board.stock_width * scale) / 2, padding - 5);
        
        ctx.save();
        ctx.translate(padding - 15, padding + (board.stock_height * scale) / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText(`${board.stock_height.toFixed(0)}mm`, 0, 0);
        ctx.restore();

        const parts = board.parts || [];
        canvas.boardIndex = boardIndex;
        canvas.boardData = board;
        parts.forEach((part, partIndex) => {
            const partX = padding + part.x * scale;
            const partY = padding + part.y * scale;
            const partWidth = part.width * scale;
            const partHeight = part.height * scale;

            ctx.fillStyle = getMaterialColor(part.material);
            ctx.fillRect(partX, partY, partWidth, partHeight);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.strokeRect(partX, partY, partWidth, partHeight);

            canvas.partData = canvas.partData || [];
            canvas.partData.push({
                x: partX, y: partY, width: partWidth, height: partHeight,
                part: part, boardIndex: boardIndex
            });

            if (partWidth > 30 && partHeight > 20) {
                // Larger, centered white labels for readability
                ctx.fillStyle = '#ffffff';
                ctx.font = `bold ${Math.max(12, 14 * scale)}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const labelContent = String(part.instance_id || `P${partIndex + 1}`);
                const maxChars = Math.max(6, Math.floor(partWidth / 8));
                const displayLabel = labelContent.length > maxChars ? labelContent.slice(0, maxChars - 1) + '…' : labelContent;
                ctx.fillText(displayLabel, partX + partWidth / 2, partY + partHeight / 2);
            }

            if (partWidth > 50) {
                ctx.fillStyle = '#ffffff';
                ctx.font = `${Math.max(10, 11 * scale)}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                ctx.fillText(`${Math.round(part.width)}mm`, partX + partWidth / 2, partY + 5);
            }

            if (partHeight > 50) {
                ctx.save();
                ctx.translate(partX + 5, partY + partHeight / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillStyle = '#ffffff';
                ctx.font = `${Math.max(10, 11 * scale)}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                ctx.fillText(`${Math.round(part.height)}mm`, 0, 0);
                ctx.restore();
            }
        });

        canvas.addEventListener('click', (e) => handleCanvasClick(e, canvas));
        canvas.addEventListener('mousemove', (e) => handleCanvasHover(e, canvas));
        canvas.style.cursor = 'pointer';
    });
}
        
        function renderReport() {
            if (!g_reportData) return;

            const summaryTable = document.getElementById('summaryTable');
            const totalCost = calculateTotalProjectCost();
            const efficiency = calculateOverallEfficiency();
            
            summaryTable.innerHTML = `
                <tr><th>Metric</th><th>Value</th></tr>
                <tr><td>Total Parts Instances</td><td>${g_reportData.summary.total_parts_instances || 0}</td></tr>
                <tr><td>Total Unique Part Types</td><td>${g_reportData.summary.total_unique_part_types || 0}</td></tr>
                <tr><td>Total Boards</td><td>${g_reportData.summary.total_boards || 0}</td></tr>
                <tr><td>Overall Efficiency</td><td>${efficiency.toFixed(2)}%</td></tr>
                <tr><td><strong>Total Project Cost</strong></td><td class="total-highlight"><strong>$${totalCost.toFixed(2)}</strong></td></tr>
            `;

            const materialsContainer = document.getElementById('materialsContainer');
            if (materialsContainer && g_reportData.unique_board_types) {
                materialsContainer.innerHTML = g_reportData.unique_board_types.map((board_type, index) => `
                    <div class="material-item" onclick="scrollToDiagram('${board_type.material}')" style="cursor: pointer;">
                        <div class="material-swatch" style="background: ${getMaterialColor(board_type.material)}"></div>
                        <span class="material-name">${board_type.material}</span>
                        <span class="material-price">Price: $${(board_type.price_per_sheet || 0).toFixed(2)}</span>
                    </div>
                `).join('');
            }

            const uniquePartTypesTable = document.getElementById('uniquePartTypesTable');
            if (uniquePartTypesTable) {
                uniquePartTypesTable.innerHTML = `
                    <tr><th>Name</th><th>W (mm)</th><th>H (mm)</th><th>Thick (mm)</th><th>Material</th><th>Grain</th><th>Total Qty</th><th>Total Area (m²)</th></tr>
                `;
                if (g_reportData.unique_part_types) {
                    g_reportData.unique_part_types.forEach(part_type => {
                        uniquePartTypesTable.innerHTML += `
                            <tr>
                                <td>${part_type.name}</td>
                                <td>${part_type.width.toFixed(2)}</td>
                                <td>${part_type.height.toFixed(2)}</td>
                                <td>${part_type.thickness.toFixed(2)}</td>
                                <td>${part_type.material}</td>
                                <td>${part_type.grain_direction}</td>
                                <td class="total-highlight">${part_type.total_quantity}</td>
                                <td>${(part_type.total_area / 1000000).toFixed(3)}</td>
                            </tr>
                        `;
                    });
                }
            }

            const uniqueBoardTypesTable = document.getElementById('uniqueBoardTypesTable');
            if (uniqueBoardTypesTable) {
                uniqueBoardTypesTable.innerHTML = `
                    <tr><th>Material</th><th>Dimensions</th><th>Count</th><th>Total Area (m²)</th><th>Price/Sheet</th><th>Total Cost</th></tr>
                `;
                if (g_reportData.unique_board_types) {
                    g_reportData.unique_board_types.forEach(board_type => {
                        uniqueBoardTypesTable.innerHTML += `
                            <tr>
                                <td>${board_type.material}</td>
                                <td>${board_type.dimensions}</td>
                                <td class="total-highlight">${board_type.count}</td>
                                <td>${(board_type.total_area / 1000000).toFixed(3)}</td>
                                <td>$${(board_type.price_per_sheet || 0).toFixed(2)}</td>
                                <td class="total-highlight">$${(board_type.total_cost || 0).toFixed(2)}</td>
                            </tr>
                        `;
                    });
                }
            }

            const boardsTable = document.getElementById('boardsTable');
            boardsTable.innerHTML = `
                <tr><th>Board#</th><th>Material</th><th>Size</th><th>Parts</th><th>Efficiency</th></tr>
            `;
            if (g_reportData.boards) {
                g_reportData.boards.forEach(board => {
                    boardsTable.innerHTML += `
                        <tr>
                            <td>${board.board_number}</td>
                            <td>${board.material}</td>
                            <td>${board.stock_size}</td>
                            <td class="total-highlight">${board.parts_count}</td>
                            <td>${board.efficiency.toFixed(2)}%</td>
                        </tr>
                    `;
                });
            }

            const partsTable = document.getElementById('partsTable');
            partsTable.innerHTML = `
                <tr><th>Unique ID</th><th>Name</th><th>Dimensions</th><th>Material</th><th>Board#</th></tr>
            `;
            const parts_list = g_reportData.parts_placed || g_reportData.parts || [];
            parts_list.forEach(part => {
                const partId = part.part_unique_id || part.part_number;
                const dimensionsStr = `${part.width.toFixed(0)} × ${part.height.toFixed(0)}mm`;
                partsTable.innerHTML += `
                    <tr data-part-id="${partId}" data-board-number="${part.board_number}">
                        <td class="part-label-cell" onclick="scrollToPieceDiagram('${partId}', ${part.board_number})">${partId}</td>
                        <td>${part.name}</td>
                        <td class="part-dimensions-cell" onclick="scrollToPieceDiagram('${partId}', ${part.board_number})">${dimensionsStr}</td>
                        <td>${part.material}</td>
                        <td>${part.board_number}</td>
                    </tr>
                `;
            });
            
            attachPartTableClickHandlers();
        }
        
        function scrollToDiagram(material) {
    // Sanitize material name for ID matching
    const sanitizedMaterial = material.replace(/[^a-zA-Z0-9]/g, '_');
    const diagrams = document.querySelectorAll(`[id^="diagram-${sanitizedMaterial}-"]`);
    if (diagrams.length > 0) {
        diagrams[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}
        
        function scrollToPieceDiagram(partId, boardNumber) {
    // Find the board diagram that contains this piece
    const boardIndex = boardNumber - 1; // Convert to 0-based index
    
    if (boardIndex < 0 || boardIndex >= g_boardsData.length) {
        console.warn(`Board ${boardNumber} not found`);
        return;
    }
    
    const board = g_boardsData[boardIndex];
    const diagramContainer = document.getElementById('diagramsContainer');
    
    if (!diagramContainer) {
        console.warn('Diagrams container not found');
        return;
    }
    
    // Find the canvas for this board
    const diagrams = diagramContainer.querySelectorAll('.diagram-card');
    let targetCanvas = null;
    let targetCard = null;
    
    if (boardIndex < diagrams.length) {
        targetCard = diagrams[boardIndex];
        targetCanvas = targetCard.querySelector('canvas');
    }
    
    if (!targetCanvas) {
        console.warn(`Canvas for board ${boardNumber} not found`);
        return;
    }
    
    // Clear previous highlight
    clearPieceHighlight();
    
    // Find the piece in the canvas data
    if (targetCanvas.partData) {
        for (let partData of targetCanvas.partData) {
            const partLabel = String(partData.part.instance_id || `P${partData.part.index || 0}`);
            if (partLabel === partId) {
                // Highlight this piece on the canvas
                highlightPieceOnCanvas(targetCanvas, partData);
                currentHighlightedPiece = partId;
                currentHighlightedCanvas = targetCanvas;
                break;
            }
        }
    }
    
    // Scroll the diagram card into view
    if (targetCard) {
        targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}
        
        function highlightPieceOnCanvas(canvas, partData) {
    // Redraw the canvas with the piece highlighted
    const ctx = canvas.getContext('2d');

    // Store original drawing function if not already stored
    if (!canvas.originalDraw) {
        canvas.originalDraw = canvas.toDataURL();
    }

    // Add a visual highlight by drawing a border around the piece
    ctx.strokeStyle = '#007bff';
    ctx.lineWidth = 3;

    // Draw highlight border
    ctx.strokeRect(
        partData.x - 2,
        partData.y - 2,
        partData.width + 4,
        partData.height + 4
    );
}
        
        function clearPieceHighlight() {
    if (currentHighlightedCanvas) {
        // Redraw the canvas to remove highlight
        const board = g_boardsData[currentHighlightedCanvas.boardIndex];
        if (board) {
            // Redraw the entire diagram
            redrawCanvasDiagram(currentHighlightedCanvas, board);
        }
        currentHighlightedCanvas = null;
        currentHighlightedPiece = null;
    }
}
        
        function redrawCanvasDiagram(canvas, board) {
    const ctx = canvas.getContext('2d');
    const padding = 40;
    const maxCanvasDim = 600;
    const scale = Math.min(
        (maxCanvasDim - 2 * padding) / board.stock_width,
        (maxCanvasDim - 2 * padding) / board.stock_height
    );

    canvas.width = board.stock_width * scale + 2 * padding;
    canvas.height = board.stock_height * scale + 2 * padding;

    ctx.fillStyle = '#f5f5f5';
    ctx.fillRect(padding, padding, board.stock_width * scale, board.stock_height * scale);
    ctx.strokeStyle = '#666';
    ctx.lineWidth = 2;
    ctx.strokeRect(padding, padding, board.stock_width * scale, board.stock_height * scale);
    
    ctx.fillStyle = '#333';
    ctx.font = `${Math.max(12, 14 * scale)}px Arial`;
    ctx.textAlign = 'center';
    ctx.fillText(`${board.stock_width.toFixed(0)}mm`, padding + (board.stock_width * scale) / 2, padding - 5);
    
    ctx.save();
    ctx.translate(padding - 15, padding + (board.stock_height * scale) / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText(`${board.stock_height.toFixed(0)}mm`, 0, 0);
    ctx.restore();

    const parts = board.parts || [];
    canvas.partData = [];
    
    parts.forEach((part, partIndex) => {
        const partX = padding + part.x * scale;
        const partY = padding + part.y * scale;
        const partWidth = part.width * scale;
        const partHeight = part.height * scale;

        ctx.fillStyle = getMaterialColor(part.material);
        ctx.fillRect(partX, partY, partWidth, partHeight);
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1;
        ctx.strokeRect(partX, partY, partWidth, partHeight);

        canvas.partData.push({
            x: partX, y: partY, width: partWidth, height: partHeight,
            part: part, boardIndex: board.index || 0
        });

        if (partWidth > 30 && partHeight > 20) {
            ctx.fillStyle = '#ffffff';
            ctx.font = `bold ${Math.max(12, 14 * scale)}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const labelContent = String(part.instance_id || `P${partIndex + 1}`);
            const maxChars = Math.max(6, Math.floor(partWidth / 8));
            const displayLabel = labelContent.length > maxChars ? labelContent.slice(0, maxChars - 1) + '…' : labelContent;
            ctx.fillText(displayLabel, partX + partWidth / 2, partY + partHeight / 2);
        }

        if (partWidth > 50) {
            ctx.fillStyle = '#ffffff';
            ctx.font = `${Math.max(10, 11 * scale)}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText(`${Math.round(part.width)}mm`, partX + partWidth / 2, partY + 5);
        }

        if (partHeight > 50) {
            ctx.save();
            ctx.translate(partX + 5, partY + partHeight / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillStyle = '#ffffff';
            ctx.font = `${Math.max(10, 11 * scale)}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText(`${Math.round(part.height)}mm`, 0, 0);
            ctx.restore();
        }
    });
}
        
        function attachPartTableClickHandlers() {
    // Add hover styling to make cells look clickable
    const partLabelCells = document.querySelectorAll('.part-label-cell, .part-dimensions-cell');
    partLabelCells.forEach(cell => {
        cell.style.cursor = 'pointer';
        cell.style.textDecoration = 'underline';
        cell.style.color = '#0066cc';
        
        cell.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e3f2fd';
            this.style.fontWeight = 'bold';
        });
        
        cell.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
            this.style.fontWeight = '';
        });
    });
}
        
        function handleCanvasClick(e, canvas) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    if (canvas.partData) {
        for (let partData of canvas.partData) {
            if (x >= partData.x && x <= partData.x + partData.width &&
                y >= partData.y && y <= partData.y + partData.height) {
                showPartModal(partData.part);
                break;
            }
        }
    }
}
        
        function handleCanvasHover(e, canvas) {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    let hovering = false;
    if (canvas.partData) {
        for (let partData of canvas.partData) {
            if (x >= partData.x && x <= partData.x + partData.width &&
                y >= partData.y && y <= partData.y + partData.height) {
                hovering = true;
                break;
            }
        }
    }
    canvas.style.cursor = hovering ? 'pointer' : 'default';
}
        
        function showPartModal(part) {
    const modal = document.getElementById('partModal');
    const modalCanvas = document.getElementById('modalCanvas');
    const modalInfo = document.getElementById('modalInfo');
    
    initThreeJS(part, modalCanvas);
    setupOrbitControls();
    
    modalInfo.innerHTML = `
        <h3>${part.name}</h3>
        <p><strong>Dimensions:</strong> ${part.width.toFixed(1)} × ${part.height.toFixed(1)} × ${part.thickness.toFixed(1)}mm</p>
        <p><strong>Area:</strong> ${(part.width * part.height / 1000000).toFixed(3)} m²</p>
        <p><strong>Material:</strong> ${part.material}</p>
        <p><strong>Grain Direction:</strong> ${part.grain_direction || 'Any'}</p>
        <p><strong>Rotated:</strong> ${part.rotated ? 'Yes' : 'No'}</p>
        <p style="color: #666; font-size: 12px;">Left drag: orbit | Middle/Shift+Left drag: pan | Scroll: zoom</p>
    `;
    
    document.getElementById('projectionToggle').onclick = () => {
        isOrthographic = !isOrthographic;
        document.getElementById('projectionToggle').textContent = isOrthographic ? 'Perspective' : 'Orthographic';
        
        if (isOrthographic) {
            const distance = camera.position.distanceTo(controls.target);
            camera = new THREE.OrthographicCamera(-distance, distance, distance, -distance, 0.1, 1000);
        } else {
            camera = new THREE.PerspectiveCamera(75, renderer.domElement.width / renderer.domElement.height, 0.1, 1000);
        }
        camera.position.set(5, 5, 5);
        controls.object = camera;
    };
    
    currentPart = part;
    modal.style.display = 'block';
    animate();
}
        
        function initThreeJS(part, canvas) {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f0f0);
    
    camera = new THREE.PerspectiveCamera(75, canvas.width / canvas.height, 0.1, 1000);
    camera.position.set(5, 5, 5);
    
    renderer = new THREE.WebGLRenderer({ canvas: canvas });
    renderer.setSize(canvas.width, canvas.height);
    
    const w = part.width / 100;
    const h = part.height / 100; 
    const d = part.thickness / 100;
    
    const geometry = new THREE.BoxGeometry(w, h, d);
    const material = new THREE.MeshBasicMaterial({ color: 0x74b9ff });
    cube = new THREE.Mesh(geometry, material);
    
    const edges = new THREE.EdgesGeometry(geometry);
    const edgeMaterial = new THREE.LineBasicMaterial({ color: 0x333333, linewidth: 1 });
    const wireframe = new THREE.LineSegments(edges, edgeMaterial);
    
    scene.add(cube);
    scene.add(wireframe);
}
        
        function setupOrbitControls() {
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.25;
    controls.enableZoom = true;
    controls.enablePan = true;
    controls.enableRotate = true;
    controls.minDistance = 1;
    controls.maxDistance = 50;
}
        
        function animate() {
    if (!renderer || !scene || !camera) return;
    
    controls.update();
    renderer.render(scene, camera);
    
    if (document.getElementById('partModal').style.display === 'block') {
        requestAnimationFrame(animate);
    }
}
        
        function initResizer() {
            const resizer = document.getElementById('resizer');
            const leftSide = document.getElementById('diagramsContainer');
            const rightSide = document.getElementById('reportContainer');
            
            if (!resizer || !leftSide || !rightSide) return;
            
            let isResizing = false;
            
            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const container = document.querySelector('.container');
                const containerRect = container.getBoundingClientRect();
                const newLeftWidth = e.clientX - containerRect.left;
                const totalWidth = containerRect.width;
                
                if (newLeftWidth > 200 && totalWidth - newLeftWidth > 300) {
                    leftSide.style.flex = `0 0 ${newLeftWidth}px`;
                    rightSide.style.flex = `1 1 auto`;
                }
            });
            
            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }
    
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            try {
                renderDiagrams();
                renderReport();
                
                const modal = document.getElementById('partModal');
                const closeBtn = document.querySelector('.close');
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        modal.style.display = 'none';
                    });
                }
                
                window.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
                
                initResizer();
            } catch (error) {
                console.error('Error initializing report:', error);
                console.error('g_boardsData:', g_boardsData);
                console.error('g_reportData:', g_reportData);
            }
        });
    </script>
</body>
</html>